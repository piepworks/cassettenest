{% extends 'base_site.html' %}

{% block title %}Film Stocks{% if manufacturer %}: {{ manufacturer }}{% endif %}{% endblock %}

{% block content %}
{% url 'stocks' as stocks_url %}
<div class="raw">
    <h1>
        {% if request.path != stocks_url %}<a href="{{ stocks_url }}">{% endif %}
        Film Stocks
        {% if request.path != stocks_url %}</a>{% endif %}
        {% if manufacturer %} &gt; {{ manufacturer }}{% endif %}
    </h1>

    <form id="stock_filter" method="get" action={% url 'stocks' %}>
        <div class="c-field--filter">
            <div class="inner">
                <label for="id_manufacturer">
                    Manufacturer:
                    <select name="manufacturer" id="id_manufacturer">
                        <option value="all">All manufacturers</option>
                        {% for manufacturer in manufacturers %}
                        <option value={{ manufacturer.slug }}{% if filters.manufacturer == manufacturer.slug %} selected{% endif %}>
                            {{ manufacturer }}
                        </option>
                        {% endfor %}
                    </select>
                </label>
                <label for="id_type">
                    Type:
                    <select name="type" id="id_type">
                        <option value="all">All types</option>
                        {% for key, value in type_choices.items %}
                        <option value="{{ key }}"{% if filters.type == key %} selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <button class="no-js">Filter</button>
        </div>
    </form>

    <hr />

    <section class="cards">
        {% for stock in stocks %}
            {% include 'inventory/_card.html' with name=stock location=stock.get_absolute_url type='film' sub_type='stock' film_type=stock.type %}
        {% endfor %}
    </section>
</div>
{% endblock %}

{% block page_js %}
<script>
    $('#stock_filter select').change((e) => {
        const url = new URL(window.location);
        const newManufacturer = $('#id_manufacturer').val();
        const newType = $('#id_type').val();
        let manufacturerUrl = (newManufacturer === 'all')
            ? `{% url 'stocks' %}`
            : `{% url 'stocks-manufacturer' manufacturer='m-none' %}`.replace('m-none', newManufacturer);

        if (e.target.name === 'manufacturer') {
            if (newType !== 'all') {
                manufacturerUrl += `?type=${newType}`;
            }
            window.location.href = manufacturerUrl;
        }

        if (e.target.name === 'type') {
            if (newType !== 'all') {
                console.log(`Get some ajax for ${newType}.`);
            }
        }
    });
</script>
{% endblock %}
